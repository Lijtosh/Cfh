<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Pesa Donation Form | CFH Chapel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        // Configure Tailwind to use the custom Mizizi color palette
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cfh-green': '#4CAF50',   /* Primary Green */
                        'cfh-green-hover': '#45a049',
                        'cfh-gold': '#FFC107',    /* Accent Gold (Primary CTA/Focus Ring) */
                        'cfh-gold-hover': '#e0a800', 
                        'cfh-dark-text': '#1F2937', /* Dark text for contrast against Gold */
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            /* Centering the modal */
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%; /* Ensure responsiveness */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8">
        <div class="flex flex-col items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">CFH Chapel M-Pesa Donation</h1>
            <img src="/Website/Static/JPG/1200px-M-PESA_LOGO-01.svg.png" alt="M-Pesa Logo" class="h-16 mt-4">
            <p class="text-sm text-gray-500 mt-2">We use the secure M-Pesa STK Push method.</p>
        </div>

        <form id="mpesaForm" class="space-y-6">

            <p class="text-sm text-gray-600 border-l-4 border-cfh-green pl-3 py-1 bg-gray-50">
                Ensure your phone number is in the **2547XXXXXXXX** format.
            </p>

            <div>
                <label for="phoneNumber" class="block text-gray-700 font-medium mb-1">M-Pesa Phone Number</label>
                <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="e.g., 254722123456" pattern="2547[0-9]{8}" title="Must be in 2547XXXXXXXX format" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cfh-green transition duration-200">
            </div>
            
            <div>
                <label for="amount" class="block text-gray-700 font-medium mb-1">Amount to Contribute (KES)</label>
                <input type="number" id="amount" name="amount" placeholder="e.g., 500" min="1" required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cfh-green transition duration-200">
            </div>

            <button type="submit" id="submitBtn"
                    class="w-full bg-cfh-gold text-cfh-dark-text font-bold py-3 px-4 rounded-lg shadow-md hover:bg-cfh-gold-hover focus:outline-none focus:ring-2 focus:ring-cfh-green focus:ring-offset-2 transition duration-200">
                Initiate M-Pesa STK Push ðŸ“²
            </button>
        </form>
    </div>

    <div id="statusModal" class="modal" style="display: none;">
        <div class="modal-content max-w-sm">
            <h2 id="modalTitle" class="text-2xl font-semibold mb-4 text-cfh-green">Initiating Payment...</h2>
            <p id="modalMessage" class="text-gray-700 mb-6">Sending request to M-Pesa. Please wait a moment.</p>
            <div id="loadingSpinner" class="spinner-border animate-spin inline-block w-8 h-8 border-4 rounded-full border-cfh-green border-r-transparent mx-auto mb-4" role="status"></div>
            <p id="modalError" class="text-sm text-red-600 font-bold hidden"></p>
            <button id="closeModal" class="mt-6 px-6 py-2 bg-cfh-green text-white rounded-lg hover:bg-cfh-green-hover transition duration-200">Close</button>
        </div>
    </div>
    
    <style>
        .spinner-border {
            display: inline-block;
            vertical-align: -0.125em;
            border-style: solid;
        }
    </style>

    <script>
        const form = document.getElementById('mpesaForm');
        const modal = document.getElementById('statusModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalError = document.getElementById('modalError');
        const spinner = document.getElementById('loadingSpinner');
        const submitBtn = document.getElementById('submitBtn');
        const closeModalBtn = document.getElementById('closeModal');
        
        // --- Modal Control Functions ---
        function showModal(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.classList.toggle('text-cfh-green', !isError);
            modalTitle.classList.toggle('text-red-600', isError);
            spinner.classList.add('hidden');
            modalError.classList.add('hidden');
            modal.style.display = 'flex';
        }

        function showLoading() {
            modalTitle.textContent = "Initiating Payment...";
            modalMessage.textContent = "Sending request to M-Pesa. Please wait a moment.";
            modalTitle.classList.add('text-cfh-green');
            modalTitle.classList.remove('text-red-600');
            spinner.classList.remove('hidden');
            modalError.classList.add('hidden');
            modal.style.display = 'flex';
        }

        function hideModal() {
            modal.style.display = 'none';
        }
        
        closeModalBtn.addEventListener('click', hideModal);

        // --- Form Submission Logic ---
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            const amount = document.getElementById('amount').value;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            showLoading(); // Show loading modal
            
            const payload = {
                phoneNumber: phoneNumber,
                amount: parseInt(amount, 10), // M-Pesa requires integer amounts
                // Add any other required data, like AccountReference or TransactionDesc
            };
            
            // --- The functional integration point ---
            try {
                // NOTE: REPLACE THIS URL with your actual backend STK Push endpoint
                const response = await fetch('/@app.route/mpesa', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                const data = await response.json();

                if (response.ok && data.ResponseCode === '0') {
                    // Success: Payment prompt sent!
                    showModal(
                        "Check Your Phone! ðŸ“²", 
                        "A payment prompt (STK Push) has been sent to your M-Pesa number. Please enter your PIN to complete the donation.",
                        false
                    );
                    // Clear the form fields upon successful initiation
                    form.reset(); 

                } else {
                    // Error response from the server/M-Pesa
                    const errorMsg = data.CustomerMessage || data.errorMessage || "Failed to initiate M-Pesa payment. Please check details and try again.";
                    showModal(
                        "Payment Failed", 
                        errorMsg, 
                        true
                    );
                    if (data.errorMessage) {
                         // Display detailed error if provided by the backend
                         modalError.textContent = `M-Pesa Error: ${data.errorMessage}`;
                         modalError.classList.remove('hidden');
                    }
                }

            } catch (error) {
                console.error('Network or Request Error:', error);
                showModal(
                    "Network Error", 
                    "Could not reach the payment server. Please check your internet connection and try again.", 
                    true
                );
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Initiate M-Pesa STK Push ðŸ“²';
            }
        });
    </script>

</body>
</html>